#!/bin/bash

rm lib/*~ > /dev/null
rm bin/*~ > /dev/null

if [ "`redis-cli get stage`" == "" ]; then
    echo 'what do you call your device?'
    read nick
    redis-cli set NICK $nick
    echo 'what city do you call home?'
    read city
    redis-cli set CITY "$city"
    redis-cli set TEAM NONE
    redis-cli set GROUP "$nick"
    redis-cli set TOKEN `cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1`
    redis-cli set PASS `cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 16 | head -n 1`
    passwd
    sudo apt install -y ruby emacs git screen redis mosquitto mosquitto-clients ircd-hybrid nginx tor aircrack-ng tshark nmap ii wifite netcat inotify vim
    # get network config
    sudo service ircd-hybrid restart
    # get nginx config
    sudo service nginx restart
 
    sudo gem install --no-rdoc --no-ri redis-objects mqtt pry thin sinatra
    echo 'screen -t "#" emacs -nw --load ~/.irc.el index.org' > ~/.screenrc
    echo 'screen -t ">" . cabgo/now' >> ~/.screenrc 
    cat << EOF > ~/.irc.el
(require 'erc-join)
(erc-autojoin-mode 1)
(setq erc-autojoin-channels-alist
      '(("vango.me" "#feed" "#$city" "#$nick")))
(erc :server "vango.me" :full-name "`redis-cli get DEVID`" :nick "`redis-cli get NICK`" :password "`redis-cli get PASS`")
EOF
    redis-cli set stage 0
    sudo reboot
elif [ "`redis-cli get stage`" == "-1" ]; then
    redis-cli del stage
    sudo reboot
else
    ruby bin/init.rb
fi
